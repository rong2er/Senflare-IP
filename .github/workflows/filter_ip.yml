name: Filter Proxy List by Tag

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  filter-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # ğŸ‘‡ å¿…é¡»è¦æœ‰è¿™ä¸€æ­¥ï¼Œå¦åˆ™å°±ä¼šæŠ¥ "No module named requests"
    - name: Install dependencies
      run: pip install requests

    - name: Run Filter & Ping Script
      env:
        # è¿™é‡Œå¡«ä½ çš„ TXT ä¸‹è½½åœ°å€
        SOURCE_URL: 'https://zip.cm.edu.kg/all.txt'
      run: |
        cat <<EOF > filter.py
        import requests
        import os
        import subprocess
        import concurrent.futures

        # 1. å®šä¹‰ç­›é€‰åœ°åŒº
        TARGET_TAGS = [
            "#HK",  # é¦™æ¸¯
            "#TW",  # å°æ¹¾
            "#JP",  # æ—¥æœ¬
            "#KR",  # éŸ©å›½
            "#SG",  # æ–°åŠ å¡
        ]

        # 2. Ping æ£€æµ‹å‡½æ•°
        def check_alive(line):
            try:
                # æå–IPï¼Œå»é™¤ç«¯å£å’Œæ ‡ç­¾
                ip = line.split(':')[0].strip()
                # Linuxç³»ç»Ÿä¸‹ Ping 1æ¬¡ï¼Œè¶…æ—¶2ç§’
                cmd = ['ping', '-c', '1', '-W', '2', ip]
                subprocess.check_call(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                return line
            except:
                return None

        def main():
            url = os.environ.get('SOURCE_URL')
            print(f"1. æ­£åœ¨ä¸‹è½½åˆ—è¡¨: {url}")
            
            try:
                resp = requests.get(url, timeout=30)
                resp.raise_for_status()
                all_lines = resp.text.splitlines()
                
                # --- æ ‡ç­¾ç­›é€‰ ---
                tag_filtered = []
                for line in all_lines:
                    line = line.strip()
                    if not line: continue
                    if any(tag in line.upper() for tag in TARGET_TAGS):
                        tag_filtered.append(line)
                
                # å»é‡
                tag_filtered = sorted(list(set(tag_filtered)))
                print(f"2. æ ‡ç­¾ç­›é€‰å®Œæˆï¼Œå‰©ä½™ {len(tag_filtered)} ä¸ªå€™é€‰èŠ‚ç‚¹ï¼Œå¼€å§‹ Ping æ£€æµ‹...")
                
                if not tag_filtered:
                    print("è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ ‡ç­¾çš„èŠ‚ç‚¹ã€‚")
                    exit(0)

                # --- å¹¶å‘ Ping ---
                alive_lines = []
                with concurrent.futures.ThreadPoolExecutor(max_workers=50) as executor:
                    futures = [executor.submit(check_alive, line) for line in tag_filtered]
                    
                    for future in concurrent.futures.as_completed(futures):
                        result = future.result()
                        if result:
                            alive_lines.append(result)
                            if len(alive_lines) % 10 == 0:
                                print(f"  -> å·²ç¡®è®¤ {len(alive_lines)} ä¸ªå­˜æ´»...")

                print(f"3. æ£€æµ‹å®Œæˆï¼å­˜æ´»: {len(alive_lines)} / åŸæœ‰: {len(tag_filtered)}")
                
                # ä¿å­˜ç»“æœ
                with open('asian_ip.txt', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(alive_lines))
                    
            except Exception as e:
                print(f"å‘ç”Ÿé”™è¯¯: {e}")
                exit(1)

        if __name__ == '__main__':
            main()
        EOF
        
        python filter.py

    - name: Commit and Push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add asian_ip.txt
        git commit -m "Auto update Asian IPs: $(date +'%Y-%m-%d')" || exit 0
        git push
