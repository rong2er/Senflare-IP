name: Filter Proxy List by Tag

# 触发机制：每天 UTC 2:00 (北京时间 10:00) 自动运行，或者手动点击运行
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  filter-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install requests

    - name: Run Filter Script
      # 请在这里填入你的 TXT/订阅链接
      env:
        SOURCE_URL: 'https://zip.cm.edu.kg/all.txt'
      run: |
        cat <<EOF > filter.py
        import requests
        import os

        # 定义我们要筛选的地区标签 (基于你提供的截图格式)
        # 只要行内包含这些字符串的任意一个，就会被保留
        TARGET_TAGS = [
            "#HK",  # 香港
            "#TW",  # 台湾
            "#JP",  # 日本
            "#KR",  # 韩国
            "#SG",  # 新加坡
            
            # 如果你的列表里有中文标签，也可以加在这里，例如：
            # "#香港", "#日本"
        ]

        def main():
            url = os.environ.get('SOURCE_URL')
            print(f"正在下载列表: {url}")
            
            try:
                # 下载内容
                resp = requests.get(url, timeout=30)
                resp.raise_for_status()
                
                # 按行分割
                all_lines = resp.text.splitlines()
                print(f"下载成功，原始行数: {len(all_lines)}")
                
                filtered_lines = []
                
                for line in all_lines:
                    line = line.strip()
                    if not line:
                        continue
                        
                    # 核心筛选逻辑：检查行内是否包含目标标签
                    # 使用 .upper() 确保 #hk 和 #HK 都能识别
                    if any(tag in line.upper() for tag in TARGET_TAGS):
                        filtered_lines.append(line)
                
                # 去重（防止同一节点出现多次）
                filtered_lines = sorted(list(set(filtered_lines)))
                
                print(f"筛选完成，命中行数: {len(filtered_lines)}")
                
                if len(filtered_lines) == 0:
                    print("警告：结果为 0。请检查 SOURCE_URL 是否正确，或者文件内的标签格式是否真的是 #HK")
                
                # 保存结果
                with open('asian_proxies.txt', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(filtered_lines))
                    
            except Exception as e:
                print(f"发生错误: {e}")
                exit(1)

        if __name__ == '__main__':
            main()
        EOF
        
        python filter.py

    - name: Commit and Push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # 如果文件有变动才提交
        git add asian_ip.txt
        git commit -m "Auto update Proxy List: $(date +'%Y-%m-%d')" || exit 0
        git push
